<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  
  <title>PostgreSQL HA with Repmgr and Keepalived | ILOSAUR.US</title>



  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="tech news, tech websites, tech blog, newtech, bacaan, artikel IT, openstack, gitlab, github, cicd, ansible, jenkins, devops, kubernetes, k8s, k3s, openshift, okd, ceph, graylog, microservices, docker, container, mesos" />
  
  
    <meta name="google-site-verification" content="oAfxaqK8OxPyKzzeOVUBOT0LwzkHXoXz9OPISmcucsA" />
  
  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-104529904-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-104529904-3');
</script>


  <script type="application/ld+json">
  {
    "@context": "http://schema.org/",
    "@type": "Person",
    "name": "Muhammad Ilham Syarifuddin",
    "alternateName": "ilosaurus",
    "url": "https://ilosaur.us",
    "image": "",
    "sameAs": [
      "https://www.facebook.com/muhilhams",
      "https://twitter.com/MuhIlham_S",
      "https://www.instagram.com/muhammadilhamsyarifuddin/",
      "https://www.linkedin.com/in/muhammadilhamsyarifuddin/",
      "https://github.com/ilosaurus"
    ],
    "jobTitle": "SysOps Engineer"  
  }
  </script>

  <meta name="description" content="PostgreSQL HA with repmgr and keepalived (pg_rewind)PostgreSQLPostgreSQL is a powerful, open-source relational database management system (RDBMS) that has earned a reputation for reliability, feature">
<meta property="og:type" content="article">
<meta property="og:title" content="PostgreSQL HA with Repmgr and Keepalived">
<meta property="og:url" content="https://ilosaur.us/2024/06/09/PostgreSQL-HA-with-Repmgr-and-Keepalived/index.html">
<meta property="og:site_name" content="ILOSAUR.US">
<meta property="og:description" content="PostgreSQL HA with repmgr and keepalived (pg_rewind)PostgreSQLPostgreSQL is a powerful, open-source relational database management system (RDBMS) that has earned a reputation for reliability, feature">
<meta property="og:locale" content="id_ID">
<meta property="og:image" content="https://ilosaur.us/images/PostgreSQLHAHLD.png">
<meta property="og:image" content="https://ilosaur.us/images/PostgreSQLHAPGREWIND.png">
<meta property="article:published_time" content="2024-06-09T06:43:00.000Z">
<meta property="article:modified_time" content="2024-06-10T09:49:03.691Z">
<meta property="article:author" content="muhilhams">
<meta property="article:tag" content="database">
<meta property="article:tag" content="postgresql">
<meta property="article:tag" content="replication">
<meta property="article:tag" content="repmgr">
<meta property="article:tag" content="keepalived">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ilosaur.us/images/PostgreSQLHAHLD.png">
<meta name="twitter:creator" content="@muhilham_s">
  
    <link rel="alternate" href="/atom.xml" title="ILOSAUR.US" type="application/atom+xml">
  
  <meta name="twitter:site" content="@muhilham_sl">
<meta property="og:type" content="website"/>
<meta name="robots" content="index, follow">
<meta name="theme-color" content="#ffffff"/>
<meta name="author" content="Muhammad Ilham Syarifuddin">
<meta name="format-detection" content="telephone=no"/>
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet"  type="text/css">
  
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}
  </style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Oswald%3A300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  
<link rel="stylesheet" href="/css/style.css">


  
<script src="/js/jquery-3.1.1.min.js"></script>


  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >
  <link rel="stylesheet" href="/css/fashion.css" >
  <link rel="stylesheet" href="/css/glyphs.css" >

<meta name="generator" content="Hexo 7.2.0"></head>



  <body data-spy="scroll" data-target="#toc" data-offset="50">


  


<header id="allheader" class="site-header" role="banner" 
   >
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="ILOSAUR.US" rel="home"> ILOSAUR.US </a>
            
          </h1>
          
          
            <div class="site-description">Ideas shared, knowledge spread</div>
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows"  style="touch-action: pan-y;">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/">beranda</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/archives">arsip</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/categories">kategori</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/about">tentang</a> </li>
                    
              </ul>
            </div>
          </nav>

      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-PostgreSQL-HA-with-Repmgr-and-Keepalived" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      PostgreSQL HA with Repmgr and Keepalived
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2024/06/09/PostgreSQL-HA-with-Repmgr-and-Keepalived/" class="article-date">
	  <time datetime="2024-06-09T06:43:00.000Z" itemprop="datePublished">Juni 9, 2024</time>
	</a>

     
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="PostgreSQL-HA-with-repmgr-and-keepalived-pg-rewind"><a href="#PostgreSQL-HA-with-repmgr-and-keepalived-pg-rewind" class="headerlink" title="PostgreSQL HA with repmgr and keepalived (pg_rewind)"></a>PostgreSQL HA with repmgr and keepalived (pg_rewind)</h1><h2 id="PostgreSQL"><a href="#PostgreSQL" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h2><p>PostgreSQL is a powerful, open-source relational database management system (RDBMS) that has earned a reputation for reliability, feature robustness, and performance. It supports a wide range of data types and advanced data handling capabilities, including transactions, foreign keys, views, triggers, and stored procedures. PostgreSQL is designed to handle a variety of workloads, from single-machine applications to web services with many concurrent users.</p>
<p>High Availability (HA) in PostgreSQL ensures that the database system remains operational and accessible even in the event of hardware or software failures. HA setups typically involve multiple database servers configured in such a way that if the primary server goes down, one of the standby servers can take over with minimal downtime. This is crucial for applications requiring continuous uptime and data reliability.</p>
<span id="more"></span>


<h2 id="PostgreSQL-HA-with-keepalived-and-repmgr"><a href="#PostgreSQL-HA-with-keepalived-and-repmgr" class="headerlink" title="PostgreSQL HA with keepalived and repmgr"></a>PostgreSQL HA with keepalived and repmgr</h2><p>Implementing HA in PostgreSQL can be achieved using various tools and techniques. Two critical components often used are:</p>
<ul>
<li><strong>repmgr</strong>: A suite of open-source tools to manage replication and failover within a cluster of PostgreSQL servers.</li>
<li><strong>keepalived</strong>: A routing software written in C. It provides simple and robust facilities for load balancing and high-availability. keepalived uses the Virtual Router Redundancy Protocol (VRRP) to ensure that a high-availability cluster of PostgreSQL servers can continue to serve clients seamlessly even if the master server fails.</li>
</ul>
<h2 id="HLD"><a href="#HLD" class="headerlink" title="HLD"></a>HLD</h2><img src="/images/PostgreSQLHAHLD.png" alt="" width="500"/>
  
<hr>
<h2 id="Recovery-Scenario"><a href="#Recovery-Scenario" class="headerlink" title="Recovery Scenario"></a>Recovery Scenario</h2><img src="/images/PostgreSQLHAPGREWIND.png" alt="" width="500"/>
  
<hr>
<p>A common problem in HA setups is the “split-brain” scenario, where two nodes believe they are both the primary, leading to data inconsistency. This can be prevented using <code>pg_rewind</code>, a PostgreSQL tool that synchronizes a failed primary with the new primary, ensuring data consistency before it rejoins as a standby.</p>
<h2 id="Step-by-Step-Configuration-and-Testing"><a href="#Step-by-Step-Configuration-and-Testing" class="headerlink" title="Step-by-Step Configuration and Testing"></a>Step-by-Step Configuration and Testing</h2><p>This guide walks you through setting up a PostgreSQL HA cluster with repmgr and keepalived, and demonstrates how to test it from an application node.</p>
<h3 id="Cluster-Configuration"><a href="#Cluster-Configuration" class="headerlink" title="Cluster Configuration"></a>Cluster Configuration</h3><h4 id="Step-1-Setup-PostgreSQL-on-all-nodes"><a href="#Step-1-Setup-PostgreSQL-on-all-nodes" class="headerlink" title="Step 1: Setup PostgreSQL on all nodes"></a>Step 1: Setup PostgreSQL on all nodes</h4><h5 id="Execute-on-both-node"><a href="#Execute-on-both-node" class="headerlink" title="Execute on both node"></a>Execute on both node</h5><p>Install PostgreSQL on all nodes (ilham-node1, ilham-node2).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install postgresql postgresql-contrib</span><br></pre></td></tr></table></figure>

<h4 id="Step-2-Configure-PostgreSQL-for-Replication"><a href="#Step-2-Configure-PostgreSQL-for-Replication" class="headerlink" title="Step 2: Configure PostgreSQL for Replication"></a>Step 2: Configure PostgreSQL for Replication</h4><h5 id="Execute-on-both-node-1"><a href="#Execute-on-both-node-1" class="headerlink" title="Execute on both node"></a>Execute on both node</h5><p>On all nodes, edit the <code>postgresql.conf</code> file to enable replication and configure necessary settings.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">shared_buffers = 2GB</span><br><span class="line">max_connections = 200</span><br><span class="line"></span><br><span class="line">listen_addresses = &#x27;*&#x27;</span><br><span class="line">wal_level = &#x27;replica&#x27;</span><br><span class="line">wal_log_hints = on</span><br><span class="line">archive_mode = on</span><br><span class="line">archive_command = &#x27;cp %p /var/lib/postgresql/16/main/archive/%f&#x27;</span><br><span class="line">max_wal_senders = 10</span><br><span class="line">max_replication_slots = 10</span><br><span class="line">wal_keep_size = 64MB</span><br><span class="line">hot_standby = on</span><br><span class="line">shared_preload_libraries = &#x27;repmgr&#x27;</span><br></pre></td></tr></table></figure>

<p>Update the <code>pg_hba.conf</code> file to allow replication connections.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TYPE  DATABASE        USER            ADDRESS                 METHOD</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># &quot;local&quot; is for Unix domain socket connections only</span></span><br><span class="line"><span class="built_in">local</span>   all             all                                     trust</span><br><span class="line"><span class="comment"># IPv4 local connections:</span></span><br><span class="line">host    all             all             127.0.0.1/32            scram-sha-256</span><br><span class="line"><span class="comment"># IPv6 local connections:</span></span><br><span class="line">host    all             all             ::1/128                 scram-sha-256</span><br><span class="line"><span class="comment"># Allow replication connections from localhost, by a user with the</span></span><br><span class="line"><span class="comment"># replication privilege.</span></span><br><span class="line"><span class="built_in">local</span>   replication     all                                     trust</span><br><span class="line">host    replication     repmgr          0.0.0.0/0               trust</span><br><span class="line">host    replication     repmgr          192.168.0.0/24          md5</span><br><span class="line">host    replication     repmgr          192.168.0.21/24         md5</span><br><span class="line">host    replication     repmgr          192.168.0.22/24         md5</span><br><span class="line">host    all             all             0.0.0.0/0               trust</span><br><span class="line">host    repmgr          repmgr          192.168.0.0/24          md5</span><br><span class="line">host    repmgr          repmgr          192.168.0.21/24         md5</span><br><span class="line">host    repmgr          repmgr          192.168.0.22/24         md5</span><br><span class="line">host    replication     all             127.0.0.1/32            scram-sha-256</span><br><span class="line">host    replication     all             ::1/128                 scram-sha-256</span><br></pre></td></tr></table></figure>

<p>Setup postgres user</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sudoers.d/postgres </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">postgres ALL=(ALL) NOPASSWD: ALL</span><br><span class="line">postgres ALL=(ALL) NOPASSWD: /bin/systemctl start postgresql.service</span><br><span class="line">postgres ALL=(ALL) NOPASSWD: /bin/systemctl stop postgresql.service</span><br><span class="line">postgres ALL=(ALL) NOPASSWD: /bin/systemctl restart postgresql.service</span><br><span class="line">postgres ALL=(ALL) NOPASSWD: /bin/systemctl reload postgresql.service</span><br></pre></td></tr></table></figure>


<p>Restart PostgreSQL server on both node</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">enable</span> postgresql</span><br><span class="line">sudo systemctl restart postgresql</span><br><span class="line">sudo systemctl status postgresql</span><br><span class="line">sudo ss -nlptu | grep postgres</span><br></pre></td></tr></table></figure>


<h4 id="Step-3-Initialize-the-Primary-Node-ilham-node1"><a href="#Step-3-Initialize-the-Primary-Node-ilham-node1" class="headerlink" title="Step 3: Initialize the Primary Node (ilham-node1)"></a>Step 3: Initialize the Primary Node (ilham-node1)</h4><h5 id="Execute-on-primary-node-ilham-node1"><a href="#Execute-on-primary-node-ilham-node1" class="headerlink" title="Execute on primary node (ilham-node1)"></a>Execute on primary node (ilham-node1)</h5><p>Create the repmgr user and database on Primary</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /etc/repmgr/16/</span><br><span class="line">sudo <span class="built_in">touch</span> /etc/repmgr/16/repmgr.conf</span><br><span class="line"><span class="built_in">chown</span> -R postgres:postgres /etc/repmgr/16/</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/repmgr/16/repmgr.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">node_id=1</span><br><span class="line">node_name=&#x27;ilham-node1&#x27;</span><br><span class="line">conninfo=&#x27;host=192.168.0.21 user=repmgr dbname=repmgr connect_timeout=2&#x27;</span><br><span class="line">data_directory=&#x27;/var/lib/postgresql/16/main&#x27;</span><br><span class="line">use_replication_slots=1</span><br><span class="line">log_level=INFO</span><br><span class="line">log_file=&#x27;/var/log/repmgr/repmgr.log&#x27;</span><br><span class="line">pg_bindir=&#x27;/usr/lib/postgresql/16/bin&#x27;</span><br><span class="line">promote_command=&#x27;/usr/local/bin/promote.sh&#x27;</span><br><span class="line">follow_command=&#x27;/usr/local/bin/follow.sh&#x27;</span><br><span class="line">standby_disconnect_on_failover=true</span><br><span class="line">failover=&#x27;automatic&#x27;</span><br><span class="line">reconnect_attempts=6</span><br><span class="line">reconnect_interval=10</span><br><span class="line">monitor_interval_secs=2</span><br><span class="line">node_rejoin_timeout=30</span><br><span class="line">standby_reconnect_timeout=30</span><br><span class="line">log_status_interval=20</span><br><span class="line">ssh_options=&#x27;-o &quot;StrictHostKeyChecking=no&quot;&#x27;</span><br><span class="line">service_start_command=&#x27;sudo /usr/bin/systemctl start postgresql&#x27;</span><br><span class="line">service_stop_command=&#x27;sudo /usr/bin/systemctl stop postgresql&#x27;</span><br><span class="line">service_restart_command=&#x27;sudo /usr/bin/systemctl restart postgresql&#x27;</span><br><span class="line">service_reload_command=&#x27;sudo /usr/bin/systemctl reload postgresql&#x27;</span><br></pre></td></tr></table></figure>

<p>Create a replication user and setup the primary database.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo -u postgres createuser --superuser repmgr</span><br><span class="line">sudo -u postgres createdb --owner=repmgr repmgr</span><br><span class="line">sudo -u postgres psql -c <span class="string">&quot;ALTER USER repmgr SET search_path TO repmgr, public;&quot;</span></span><br><span class="line">sudo -u postgres psql -c <span class="string">&quot;\l&quot;</span></span><br><span class="line">sudo -u postgres psql -c <span class="string">&quot;\du&quot;</span></span><br></pre></td></tr></table></figure>


<p>Test connection from standby node:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br><span class="line">psql <span class="string">&quot;host=192.168.0.21 user=repmgr dbname=repmgr connect_timeout=2&quot;</span></span><br></pre></td></tr></table></figure>

<p>Setup follow and promote script</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">echo</span> <span class="string">&#x27;&#x27;</span> &gt; /usr/local/bin/promote.sh</span><br><span class="line">sudo <span class="built_in">echo</span> <span class="string">&#x27;&#x27;</span> &gt; /usr/local/bin/follow.sh</span><br><span class="line">sudo <span class="built_in">echo</span> <span class="string">&#x27;&#x27;</span> &gt; /var/log/repmgr/follow.log</span><br><span class="line">sudo <span class="built_in">echo</span> <span class="string">&#x27;&#x27;</span> &gt; /var/log/repmgr/promote.log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> 755 /usr/local/bin/promote.sh</span><br><span class="line"><span class="built_in">chmod</span> 755 /usr/local/bin/follow.sh</span><br><span class="line"><span class="built_in">chown</span> root:postgres /usr/local/bin/promote.sh</span><br><span class="line"><span class="built_in">chown</span> root:postgres /usr/local/bin/follow.sh</span><br><span class="line"><span class="built_in">chown</span> postgres:postgres /var/log/repmgr/follow.log</span><br><span class="line"><span class="built_in">chown</span> postgres:postgres /var/log/repmgr/promote.log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">ls</span> -l /usr/local/bin/promote.sh</span><br><span class="line"><span class="built_in">ls</span> -l /usr/local/bin/follow.sh</span><br><span class="line"><span class="built_in">ls</span> -l /var/log/repmgr/follow.log</span><br><span class="line"><span class="built_in">ls</span> -l /var/log/repmgr/promote.log</span><br></pre></td></tr></table></figure>
<p>Setup promote script</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/bin/promote.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Logging function</span></span><br><span class="line"><span class="function"><span class="title">log</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(date +&#x27;%Y-%m-%d %H:%M:%S&#x27;)</span> - <span class="variable">$1</span>&quot;</span> | <span class="built_in">tee</span> -a /var/log/repmgr/promote.log</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;Starting promotion...&quot;</span></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;Stopping repmgrd service...&quot;</span></span><br><span class="line">sudo systemctl stop repmgrd</span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;Promoting the standby to primary...&quot;</span></span><br><span class="line">sudo -u postgres repmgr standby promote -f /etc/repmgr/16/repmgr.conf --log-to-file</span><br><span class="line"><span class="built_in">sleep</span> 2</span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;Starting repmgrd service...&quot;</span></span><br><span class="line">sudo systemctl start repmgrd</span><br><span class="line"><span class="built_in">sleep</span> 2</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check if promotion was successful</span></span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Node successfully promoted to primary.&quot;</span></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Node successfully promoted to primary.&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Failed to promote node to primary.&quot;</span></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Failed to promote node to primary.&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>Setup follow script</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/bin/follow.sh</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Configuration</span></span><br><span class="line">REPMGR_CONFIG=<span class="string">&quot;/etc/repmgr/16/repmgr.conf&quot;</span></span><br><span class="line">PRIMARY_CONNINFO=<span class="string">&quot;host=192.168.0.22 dbname=repmgr user=repmgr&quot;</span></span><br><span class="line">LOGFILE=<span class="string">&quot;/var/log/repmgr/follow.log&quot;</span></span><br><span class="line">MAX_WAIT=30</span><br><span class="line">RETRY_INTERVAL=5</span><br><span class="line">RETRY_COUNT=5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Logging function</span></span><br><span class="line"><span class="function"><span class="title">log</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(date +&#x27;%Y-%m-%d %H:%M:%S&#x27;)</span> - <span class="variable">$1</span>&quot;</span> | <span class="built_in">tee</span> -a <span class="variable">$LOGFILE</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;Checking PostgreSQL status...&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Check if the node is in recovery mode (standby)</span></span><br><span class="line">IS_STANDBY=$(sudo -u postgres psql -h 192.168.0.21 -U repmgr -d repmgr -tAc <span class="string">&quot;SELECT pg_is_in_recovery()&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$IS_STANDBY</span>&quot;</span> == <span class="string">&quot;t&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Node is already standby, running follow command.&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Check if the replication slot exists before attempting to drop it</span></span><br><span class="line">    SLOT_EXISTS=$(sudo -u postgres psql -tAc <span class="string">&quot;SELECT 1 FROM pg_replication_slots WHERE slot_name = &#x27;repmgr_slot_1&#x27;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$SLOT_EXISTS</span>&quot;</span> == <span class="string">&quot;1&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Dropping existing replication slot &#x27;repmgr_slot_1&#x27;...&quot;</span></span><br><span class="line">        sudo -u postgres psql -c <span class="string">&quot;SELECT pg_drop_replication_slot(&#x27;repmgr_slot_1&#x27;)&quot;</span> 2&gt;/dev/null</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Replication slot &#x27;repmgr_slot_1&#x27; does not exist.&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    sudo -u postgres repmgr standby follow -f <span class="variable">$REPMGR_CONFIG</span> --log-to-file</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Node is primary, checking if it should be rejoined as standby.&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Check if the node is registered as standby but running as primary</span></span><br><span class="line">    NODE_STATUS=$(sudo -u postgres repmgr -f <span class="variable">$REPMGR_CONFIG</span> cluster show | grep -E <span class="string">&#x27;running as primary&#x27;</span> | grep -E <span class="string">&#x27;standby&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$NODE_STATUS</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Node is registered as a standby but running as primary. Correcting this state.&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Stopping PostgreSQL service...&quot;</span></span><br><span class="line">        sudo systemctl stop postgresql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Wait for PostgreSQL service to stop</span></span><br><span class="line">        WAIT_TIME=0</span><br><span class="line">        <span class="keyword">while</span> systemctl is-active --quiet postgresql; <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">sleep</span> 1</span><br><span class="line">            WAIT_TIME=$((WAIT_TIME+<span class="number">1</span>))</span><br><span class="line">            <span class="keyword">if</span> [ <span class="variable">$WAIT_TIME</span> -ge <span class="variable">$MAX_WAIT</span> ]; <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">log</span> <span class="string">&quot;PostgreSQL service did not stop within <span class="variable">$MAX_WAIT</span> seconds. Exiting rejoin process.&quot;</span></span><br><span class="line">                <span class="built_in">exit</span> 1</span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;PostgreSQL service stopped successfully.&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="built_in">sleep</span> 6</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Retry logic for repmgr node rejoin</span></span><br><span class="line">        RETRY=0</span><br><span class="line">        <span class="keyword">while</span> [ <span class="variable">$RETRY</span> -lt <span class="variable">$RETRY_COUNT</span> ]; <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">log</span> <span class="string">&quot;Running repmgr node rejoin (attempt <span class="subst">$((RETRY+1)</span>)/<span class="variable">$RETRY_COUNT</span>)...&quot;</span></span><br><span class="line">            sudo -u postgres repmgr node rejoin -f <span class="variable">$REPMGR_CONFIG</span> -d <span class="string">&quot;<span class="variable">$PRIMARY_CONNINFO</span>&quot;</span> --force-rewind --config-files=postgresql.local.conf,postgresql.conf --verbose</span><br><span class="line">            <span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">log</span> <span class="string">&quot;Rejoin successful.&quot;</span></span><br><span class="line">                <span class="built_in">break</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">log</span> <span class="string">&quot;Rejoin failed, retrying in <span class="variable">$RETRY_INTERVAL</span> seconds...&quot;</span></span><br><span class="line">                <span class="built_in">sleep</span> <span class="variable">$RETRY_INTERVAL</span></span><br><span class="line">                RETRY=$((RETRY+<span class="number">1</span>))</span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [ <span class="variable">$RETRY</span> -eq <span class="variable">$RETRY_COUNT</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">log</span> <span class="string">&quot;Rejoin failed after <span class="variable">$RETRY_COUNT</span> attempts. Forcing PostgreSQL to start.&quot;</span></span><br><span class="line">            sudo systemctl start postgresql</span><br><span class="line">            <span class="built_in">sleep</span> 6</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">log</span> <span class="string">&quot;Starting PostgreSQL service...&quot;</span></span><br><span class="line">            sudo systemctl start postgresql</span><br><span class="line">            <span class="built_in">sleep</span> 6</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Starting repmgrd service...&quot;</span></span><br><span class="line">        sudo systemctl restart repmgrd</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Follow script completed.&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Node is primary, but no mismatch in status detected. No action required.&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="Step-4-Initialize-the-Standby-Node-ilham-node2"><a href="#Step-4-Initialize-the-Standby-Node-ilham-node2" class="headerlink" title="Step 4: Initialize the Standby Node (ilham-node2)"></a>Step 4: Initialize the Standby Node (ilham-node2)</h4><h5 id="Execute-on-standby-node-ilham-node2"><a href="#Execute-on-standby-node-ilham-node2" class="headerlink" title="Execute on standby node (ilham-node2)"></a>Execute on standby node (ilham-node2)</h5><p>Create the repmgr user and database on Primary</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /etc/repmgr/16/</span><br><span class="line">sudo <span class="built_in">touch</span> /etc/repmgr/16/repmgr.conf</span><br><span class="line"><span class="built_in">chown</span> -R postgres:postgres /etc/repmgr/16/</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/repmgr/16/repmgr.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">node_id=2</span><br><span class="line">node_name=<span class="string">&#x27;ilham-node2&#x27;</span></span><br><span class="line">conninfo=<span class="string">&#x27;host=192.168.0.19 user=repmgr dbname=repmgr connect_timeout=2&#x27;</span></span><br><span class="line">data_directory=<span class="string">&#x27;/var/lib/postgresql/16/main&#x27;</span></span><br><span class="line">use_replication_slots=1</span><br><span class="line">log_level=INFO</span><br><span class="line">log_file=<span class="string">&#x27;/var/log/repmgr/repmgr.log&#x27;</span></span><br><span class="line">pg_bindir=<span class="string">&#x27;/usr/lib/postgresql/16/bin&#x27;</span></span><br><span class="line">promote_command=<span class="string">&#x27;repmgr standby promote -f /etc/repmgr/16/repmgr.conf&#x27;</span></span><br><span class="line">follow_command=<span class="string">&#x27;repmgr standby follow -f /etc/repmgr/16/repmgr.conf --upstream-node-id=%n&#x27;</span></span><br><span class="line">standby_disconnect_on_failover=<span class="literal">true</span></span><br><span class="line">failover=<span class="string">&#x27;automatic&#x27;</span></span><br><span class="line">reconnect_attempts=6</span><br><span class="line">reconnect_interval=10</span><br><span class="line">monitor_interval_secs=2</span><br><span class="line">node_rejoin_timeout=30</span><br><span class="line">standby_reconnect_timeout=30</span><br><span class="line">log_status_interval=20</span><br><span class="line">ssh_options=<span class="string">&#x27;-o &quot;StrictHostKeyChecking=no&quot;&#x27;</span></span><br><span class="line">service_start_command=<span class="string">&#x27;sudo /usr/bin/systemctl start postgresql&#x27;</span></span><br><span class="line">service_stop_command=<span class="string">&#x27;sudo /usr/bin/systemctl stop postgresql&#x27;</span></span><br><span class="line">service_restart_command=<span class="string">&#x27;sudo /usr/bin/systemctl restart postgresql&#x27;</span></span><br><span class="line">service_reload_command=<span class="string">&#x27;sudo /usr/bin/systemctl reload postgresql&#x27;</span></span><br></pre></td></tr></table></figure>

<p>Create a replication user and setup the primary database.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo -u postgres createuser --superuser repmgr</span><br><span class="line">sudo -u postgres createdb --owner=repmgr repmgr</span><br><span class="line">sudo -u postgres psql -c <span class="string">&quot;ALTER USER repmgr SET search_path TO repmgr, public;&quot;</span></span><br><span class="line">sudo -u postgres psql -c <span class="string">&quot;\l&quot;</span></span><br><span class="line">sudo -u postgres psql -c <span class="string">&quot;\du&quot;</span></span><br></pre></td></tr></table></figure>

<p>Test connection from primary node:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br><span class="line">psql <span class="string">&quot;host=192.168.0.22 user=repmgr dbname=repmgr connect_timeout=2&quot;</span></span><br></pre></td></tr></table></figure>

<p>Setup follow and promote script</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">echo</span> <span class="string">&#x27;&#x27;</span> &gt; /usr/local/bin/promote.sh</span><br><span class="line">sudo <span class="built_in">echo</span> <span class="string">&#x27;&#x27;</span> &gt; /usr/local/bin/follow.sh</span><br><span class="line">sudo <span class="built_in">echo</span> <span class="string">&#x27;&#x27;</span> &gt; /var/log/repmgr/follow.log</span><br><span class="line">sudo <span class="built_in">echo</span> <span class="string">&#x27;&#x27;</span> &gt; /var/log/repmgr/promote.log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> 755 /usr/local/bin/promote.sh</span><br><span class="line"><span class="built_in">chmod</span> 755 /usr/local/bin/follow.sh</span><br><span class="line"><span class="built_in">chown</span> root:postgres /usr/local/bin/promote.sh</span><br><span class="line"><span class="built_in">chown</span> root:postgres /usr/local/bin/follow.sh</span><br><span class="line"><span class="built_in">chown</span> postgres:postgres /var/log/repmgr/follow.log</span><br><span class="line"><span class="built_in">chown</span> postgres:postgres /var/log/repmgr/promote.log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">ls</span> -l /usr/local/bin/promote.sh</span><br><span class="line"><span class="built_in">ls</span> -l /usr/local/bin/follow.sh</span><br><span class="line"><span class="built_in">ls</span> -l /var/log/repmgr/follow.log</span><br><span class="line"><span class="built_in">ls</span> -l /var/log/repmgr/promote.log</span><br></pre></td></tr></table></figure>
<p>Setup promote script</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/bin/promote.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Logging function</span></span><br><span class="line"><span class="function"><span class="title">log</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(date +&#x27;%Y-%m-%d %H:%M:%S&#x27;)</span> - <span class="variable">$1</span>&quot;</span> | <span class="built_in">tee</span> -a /var/log/repmgr/promote.log</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;Starting promotion...&quot;</span></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;Stopping repmgrd service...&quot;</span></span><br><span class="line">sudo systemctl stop repmgrd</span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;Promoting the standby to primary...&quot;</span></span><br><span class="line">sudo -u postgres repmgr standby promote -f /etc/repmgr/16/repmgr.conf --log-to-file</span><br><span class="line"><span class="built_in">sleep</span> 2</span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;Starting repmgrd service...&quot;</span></span><br><span class="line">sudo systemctl start repmgrd</span><br><span class="line"><span class="built_in">sleep</span> 2</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check if promotion was successful</span></span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Node successfully promoted to primary.&quot;</span></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Node successfully promoted to primary.&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Failed to promote node to primary.&quot;</span></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Failed to promote node to primary.&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>Setup follow script</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/bin/follow.sh</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Configuration</span></span><br><span class="line">REPMGR_CONFIG=<span class="string">&quot;/etc/repmgr/16/repmgr.conf&quot;</span></span><br><span class="line">PRIMARY_CONNINFO=<span class="string">&quot;host=192.168.0.21 dbname=repmgr user=repmgr&quot;</span></span><br><span class="line">LOGFILE=<span class="string">&quot;/var/log/repmgr/follow.log&quot;</span></span><br><span class="line">MAX_WAIT=30</span><br><span class="line">RETRY_INTERVAL=5</span><br><span class="line">RETRY_COUNT=5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Logging function</span></span><br><span class="line"><span class="function"><span class="title">log</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(date +&#x27;%Y-%m-%d %H:%M:%S&#x27;)</span> - <span class="variable">$1</span>&quot;</span> | <span class="built_in">tee</span> -a <span class="variable">$LOGFILE</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;Checking PostgreSQL status...&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Check if the node is in recovery mode (standby)</span></span><br><span class="line">IS_STANDBY=$(sudo -u postgres psql -h 192.168.0.22 -U repmgr -d repmgr -tAc <span class="string">&quot;SELECT pg_is_in_recovery()&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$IS_STANDBY</span>&quot;</span> == <span class="string">&quot;t&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Node is already standby, running follow command.&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Check if the replication slot exists before attempting to drop it</span></span><br><span class="line">    SLOT_EXISTS=$(sudo -u postgres psql -tAc <span class="string">&quot;SELECT 1 FROM pg_replication_slots WHERE slot_name = &#x27;repmgr_slot_1&#x27;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$SLOT_EXISTS</span>&quot;</span> == <span class="string">&quot;1&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Dropping existing replication slot &#x27;repmgr_slot_1&#x27;...&quot;</span></span><br><span class="line">        sudo -u postgres psql -c <span class="string">&quot;SELECT pg_drop_replication_slot(&#x27;repmgr_slot_1&#x27;)&quot;</span> 2&gt;/dev/null</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Replication slot &#x27;repmgr_slot_1&#x27; does not exist.&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    sudo -u postgres repmgr standby follow -f <span class="variable">$REPMGR_CONFIG</span> --log-to-file</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Node is primary, checking if it should be rejoined as standby.&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Check if the node is registered as standby but running as primary</span></span><br><span class="line">    NODE_STATUS=$(sudo -u postgres repmgr -f <span class="variable">$REPMGR_CONFIG</span> cluster show | grep -E <span class="string">&#x27;running as primary&#x27;</span> | grep -E <span class="string">&#x27;standby&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$NODE_STATUS</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Node is registered as a standby but running as primary. Correcting this state.&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Stopping PostgreSQL service...&quot;</span></span><br><span class="line">        sudo systemctl stop postgresql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Wait for PostgreSQL service to stop</span></span><br><span class="line">        WAIT_TIME=0</span><br><span class="line">        <span class="keyword">while</span> systemctl is-active --quiet postgresql; <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">sleep</span> 1</span><br><span class="line">            WAIT_TIME=$((WAIT_TIME+<span class="number">1</span>))</span><br><span class="line">            <span class="keyword">if</span> [ <span class="variable">$WAIT_TIME</span> -ge <span class="variable">$MAX_WAIT</span> ]; <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">log</span> <span class="string">&quot;PostgreSQL service did not stop within <span class="variable">$MAX_WAIT</span> seconds. Exiting rejoin process.&quot;</span></span><br><span class="line">                <span class="built_in">exit</span> 1</span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;PostgreSQL service stopped successfully.&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="built_in">sleep</span> 6</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Retry logic for repmgr node rejoin</span></span><br><span class="line">        RETRY=0</span><br><span class="line">        <span class="keyword">while</span> [ <span class="variable">$RETRY</span> -lt <span class="variable">$RETRY_COUNT</span> ]; <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">log</span> <span class="string">&quot;Running repmgr node rejoin (attempt <span class="subst">$((RETRY+1)</span>)/<span class="variable">$RETRY_COUNT</span>)...&quot;</span></span><br><span class="line">            sudo -u postgres repmgr node rejoin -f <span class="variable">$REPMGR_CONFIG</span> -d <span class="string">&quot;<span class="variable">$PRIMARY_CONNINFO</span>&quot;</span> --force-rewind --config-files=postgresql.local.conf,postgresql.conf --verbose</span><br><span class="line">            <span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">log</span> <span class="string">&quot;Rejoin successful.&quot;</span></span><br><span class="line">                <span class="built_in">break</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">log</span> <span class="string">&quot;Rejoin failed, retrying in <span class="variable">$RETRY_INTERVAL</span> seconds...&quot;</span></span><br><span class="line">                <span class="built_in">sleep</span> <span class="variable">$RETRY_INTERVAL</span></span><br><span class="line">                RETRY=$((RETRY+<span class="number">1</span>))</span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [ <span class="variable">$RETRY</span> -eq <span class="variable">$RETRY_COUNT</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">log</span> <span class="string">&quot;Rejoin failed after <span class="variable">$RETRY_COUNT</span> attempts. Forcing PostgreSQL to start.&quot;</span></span><br><span class="line">            sudo systemctl start postgresql</span><br><span class="line">            <span class="built_in">sleep</span> 6</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">log</span> <span class="string">&quot;Starting PostgreSQL service...&quot;</span></span><br><span class="line">            sudo systemctl start postgresql</span><br><span class="line">            <span class="built_in">sleep</span> 6</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Starting repmgrd service...&quot;</span></span><br><span class="line">        sudo systemctl restart repmgrd</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Follow script completed.&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Node is primary, but no mismatch in status detected. No action required.&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="Step-5-Setup-replication-cluster"><a href="#Step-5-Setup-replication-cluster" class="headerlink" title="Step 5: Setup replication cluster"></a>Step 5: Setup replication cluster</h4><h5 id="Execute-on-primary-node-ilham-node1-1"><a href="#Execute-on-primary-node-ilham-node1-1" class="headerlink" title="Execute on primary node (ilham-node1)"></a>Execute on primary node (ilham-node1)</h5><p>Register the primary node</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u postgres repmgr -f /etc/repmgr/16/repmgr.conf primary register</span><br></pre></td></tr></table></figure>
<p>Verify registration:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u postgres repmgr -f /etc/repmgr/16/repmgr.conf cluster show</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> ID | Name        | Role    | Status    | Upstream    | Location | Priority | Timeline | Connection string</span><br><span class="line">----+-------------+---------+-----------+-------------+----------+----------+----------+---------------------------------------------------------------</span><br><span class="line"> 1  | ilham-node1 | primary | * running |             | default  | 100      | 1        | host=192.168.0.21 user=repmgr dbname=repmgr connect_timeout=2</span><br></pre></td></tr></table></figure>

<h5 id="Execute-on-standby-node-ilham-node2-1"><a href="#Execute-on-standby-node-ilham-node2-1" class="headerlink" title="Execute on standby node (ilham-node2)"></a>Execute on standby node (ilham-node2)</h5><p>Clone the standby node</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -lah /var/lib/postgresql/16/main</span><br><span class="line">systemctl stop postgresql</span><br><span class="line">systemctl status postgresql</span><br><span class="line"><span class="built_in">cd</span> /var/lib/postgresql/16/main</span><br><span class="line"><span class="built_in">rm</span> -rf ./*</span><br><span class="line"><span class="built_in">ls</span> -lah /var/lib/postgresql/16/main</span><br><span class="line"><span class="built_in">cd</span> ~</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u postgres repmgr -h 10.70.200.18 -U repmgr -d repmgr -f /etc/repmgr/16/repmgr.conf standby <span class="built_in">clone</span> --dry-run</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u postgres repmgr -h 10.70.200.18 -U repmgr -d repmgr -f /etc/repmgr/16/repmgr.conf standby <span class="built_in">clone</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start postgresql</span><br><span class="line">systemctl status postgresql</span><br></pre></td></tr></table></figure>
<p>Verify registration:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo -u postgres psql</span><br><span class="line">SELECT * FROM pg_stat_wal_receiver;</span><br></pre></td></tr></table></figure>

<p>Register standby node</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u postgres repmgr -f /etc/repmgr/16/repmgr.conf standby register</span><br></pre></td></tr></table></figure>

<p>Verify registration</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u postgres repmgr -f /etc/repmgr/16/repmgr.conf cluster show</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> ID | Name        | Role    | Status    | Upstream    | Location | Priority | Timeline | Connection string</span><br><span class="line">----+-------------+---------+-----------+-------------+----------+----------+----------+---------------------------------------------------------------</span><br><span class="line"> 1  | ilham-node1 | primary | * running |             | default  | 100      | 1        | host=192.168.0.21 user=repmgr dbname=repmgr connect_timeout=2</span><br><span class="line"> 2  | ilham-node2 | standby |   running | ilham-node1 | default  | 100      | 1        | host=192.168.0.22 user=repmgr dbname=repmgr connect_timeout=2</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u postgres repmgr -f /etc/repmgr/16/repmgr.conf cluster event</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> Node ID | Name        | Event                      | OK | Timestamp           | Details</span><br><span class="line">---------+-------------+----------------------------+----+---------------------+--------------------------------------------------</span><br><span class="line"> 1       | ilham-node1 | repmgrd_start              | t  | 2024-06-06 13:39:09 | monitoring cluster primary <span class="string">&quot;ilham-node1&quot;</span> (ID: 1)</span><br><span class="line"> 2       | ilham-node2 | repmgrd_upstream_reconnect | t  | 2024-06-06 13:39:07 | reconnected to upstream node after 10 seconds</span><br><span class="line"> 1       | ilham-node1 | child_node_new_connect     | t  | 2024-06-06 13:38:16 | new standby <span class="string">&quot;ilham-node2&quot;</span> (ID: 2) has connected</span><br></pre></td></tr></table></figure>

<h4 id="Step-6-Setup-Repmgrd-Service-w-Systemd"><a href="#Step-6-Setup-Repmgrd-Service-w-Systemd" class="headerlink" title="Step 6: Setup Repmgrd Service w&#x2F; Systemd"></a>Step 6: Setup Repmgrd Service w&#x2F; Systemd</h4><h5 id="Execute-on-both-node-2"><a href="#Execute-on-both-node-2" class="headerlink" title="Execute on both node"></a>Execute on both node</h5><p>Locate the existing init script (if any):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo find /etc/init.d/ -name <span class="string">&#x27;repmgrd*&#x27;</span></span><br></pre></td></tr></table></figure>

<p>Remove or disable the existing init script:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> /etc/init.d/repmgrd /root/repmgrd.backup</span><br><span class="line"><span class="built_in">ls</span> -l /root/repmgrd.backup</span><br><span class="line">sudo <span class="built_in">rm</span> /etc/init.d/repmgrd</span><br></pre></td></tr></table></figure>

<p>Create a configuration file to ensure the necessary directory is created with the correct permissions at boot:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/tmpfiles.d/repmgrd.conf</span><br></pre></td></tr></table></figure>

<p>Add the following content to the file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">d /run/repmgr 0755 postgres postgres -</span><br></pre></td></tr></table></figure>

<p>Create and edit the repmgrd service file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">touch</span> /var/log/repmgr/repmgr.log </span><br><span class="line"><span class="built_in">chown</span> postgres:postgres /var/log/repmgr/repmgr.log</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/systemd/system/repmgrd.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Manage repmgrd <span class="keyword">for</span> PostgreSQL</span><br><span class="line">After=network.target postgresql.service</span><br><span class="line">Requires=postgresql.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">User=postgres</span><br><span class="line">ExecStart=/usr/bin/repmgrd -f /etc/repmgr/16/repmgr.conf -d --pid-file=/run/repmgr/repmgrd.pid</span><br><span class="line">PIDFile=/run/repmgr/repmgrd.pid</span><br><span class="line">ExecStop=/bin/kill -TERM <span class="variable">$MAINPID</span></span><br><span class="line">ExecReload=/bin/kill -HUP <span class="variable">$MAINPID</span></span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5s</span><br><span class="line">StandardOutput=journal</span><br><span class="line">StandardError=journal</span><br><span class="line">SyslogIdentifier=repmgrd</span><br><span class="line">RuntimeDirectory=repmgr</span><br><span class="line">RuntimeDirectoryMode=0755</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>Reload and restart service</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> repmgrd</span><br><span class="line">sudo systemctl start repmgrd</span><br><span class="line">sudo systemctl status repmgrd</span><br></pre></td></tr></table></figure>

<p>Check repmgrd logs to ensure it’s running correctly</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo journalctl -u repmgrd</span><br><span class="line">sudo -u postgres repmgr cluster show</span><br></pre></td></tr></table></figure>


<h4 id="Step-7-Configure-keepalived"><a href="#Step-7-Configure-keepalived" class="headerlink" title="Step 7: Configure keepalived"></a>Step 7: Configure keepalived</h4><h5 id="Execute-on-primary-node"><a href="#Execute-on-primary-node" class="headerlink" title="Execute on primary node"></a>Execute on primary node</h5><p>Configure file keepalived.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">echo</span> <span class="string">&#x27;&#x27;</span> &gt; /var/log/update_keepalived_priority.log</span><br><span class="line">sudo <span class="built_in">cp</span> /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.backup</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/keepalived/keepalived.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">    script_user root</span><br><span class="line">    enable_script_security</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vrrp_script pg_check &#123;</span><br><span class="line">      script <span class="string">&quot;/usr/local/bin/check_postgres.sh&quot;</span></span><br><span class="line">      interval 5</span><br><span class="line">      <span class="built_in">timeout</span> 5</span><br><span class="line">      rise 3</span><br><span class="line">      fall 3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens3</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass repmgrpa</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.0.50/24 dev ens3</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        pg_check</span><br><span class="line">    &#125;</span><br><span class="line">    notify_backup <span class="string">&quot;/usr/local/bin/follow.sh&quot;</span></span><br><span class="line">    notify_fault <span class="string">&quot;/usr/local/bin/follow.sh&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Create healtcheck script</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">touch</span> /usr/local/bin/check_postgres.sh</span><br><span class="line"><span class="built_in">chmod</span> +x /usr/local/bin/check_postgres.sh</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/bin/check_postgres.sh</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Configuration</span></span><br><span class="line">user=<span class="string">&#x27;repmgr&#x27;</span></span><br><span class="line">database=<span class="string">&#x27;repmgr&#x27;</span></span><br><span class="line">logfile=<span class="string">&#x27;/var/log/check_postgres.log&#x27;</span></span><br><span class="line">current_node=<span class="string">&#x27;192.168.0.21&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Logging function</span></span><br><span class="line"><span class="function"><span class="title">log</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(date +&#x27;%Y-%m-%d %H:%M:%S&#x27;)</span> - <span class="variable">$1</span>&quot;</span> | <span class="built_in">tee</span> -a <span class="variable">$logfile</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;Checking PostgreSQL status on node <span class="variable">$current_node</span>...&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Check if the node is in recovery mode (standby)</span></span><br><span class="line">is_standby=$(psql -h <span class="variable">$current_node</span> -U <span class="variable">$user</span> -d <span class="variable">$database</span> -tAc <span class="string">&quot;SELECT pg_is_in_recovery()&quot;</span> 2&gt;&gt; <span class="variable">$logfile</span>)</span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Error checking recovery mode on node <span class="variable">$current_node</span>.&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$is_standby</span>&quot;</span> == <span class="string">&quot;t&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Node <span class="variable">$current_node</span> is standby. Checking replication status.&quot;</span></span><br><span class="line">    replication_status=$(psql -h <span class="variable">$current_node</span> -U <span class="variable">$user</span> -d <span class="variable">$database</span> -tAc <span class="string">&quot;SELECT pg_last_wal_receive_lsn() IS NOT NULL AND pg_last_wal_replay_lsn() IS NOT NULL&quot;</span> 2&gt;&gt; <span class="variable">$logfile</span>)</span><br><span class="line">    <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Error checking replication status on node <span class="variable">$current_node</span>.&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$replication_status</span>&quot;</span> == <span class="string">&quot;t&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Replication is active on node <span class="variable">$current_node</span>. PostgreSQL is working properly.&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 0</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Replication is not active on node <span class="variable">$current_node</span>. Failover should be initiated!&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Node <span class="variable">$current_node</span> is primary. Performing create/drop table check.&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Drop the test table if it exists</span></span><br><span class="line">    psql -h <span class="variable">$current_node</span> -U <span class="variable">$user</span> -d <span class="variable">$database</span> -c <span class="string">&quot;DROP TABLE IF EXISTS test;&quot;</span> 2&gt;&gt; <span class="variable">$logfile</span></span><br><span class="line">    <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Error dropping existing test table on node <span class="variable">$current_node</span>. Failover should be initiated!&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Create the test table</span></span><br><span class="line">    psql -h <span class="variable">$current_node</span> -U <span class="variable">$user</span> -d <span class="variable">$database</span> -c <span class="string">&quot;CREATE TABLE test (id serial primary key, data varchar(255));&quot;</span> 2&gt;&gt; <span class="variable">$logfile</span></span><br><span class="line">    <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Error creating table on node <span class="variable">$current_node</span>. Failover should be initiated!&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    table_check=$(psql -h <span class="variable">$current_node</span> -U <span class="variable">$user</span> -d <span class="variable">$database</span> -tAc <span class="string">&quot;SELECT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = &#x27;test&#x27;);&quot;</span> 2&gt;&gt; <span class="variable">$logfile</span>)</span><br><span class="line">    <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Error checking table existence on node <span class="variable">$current_node</span>.&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$table_check</span>&quot;</span> == <span class="string">&quot;t&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Table created successfully on node <span class="variable">$current_node</span>.&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Drop the test table</span></span><br><span class="line">        psql -h <span class="variable">$current_node</span> -U <span class="variable">$user</span> -d <span class="variable">$database</span> -c <span class="string">&quot;DROP TABLE test;&quot;</span> 2&gt;&gt; <span class="variable">$logfile</span></span><br><span class="line">        <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">log</span> <span class="string">&quot;Error dropping table on node <span class="variable">$current_node</span>. Failover should be initiated!&quot;</span></span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        table_check=$(psql -h <span class="variable">$current_node</span> -U <span class="variable">$user</span> -d <span class="variable">$database</span> -tAc <span class="string">&quot;SELECT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = &#x27;test&#x27;);&quot;</span> 2&gt;&gt; <span class="variable">$logfile</span>)</span><br><span class="line">        <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">log</span> <span class="string">&quot;Error checking table existence after drop on node <span class="variable">$current_node</span>.&quot;</span></span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$table_check</span>&quot;</span> == <span class="string">&quot;f&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">log</span> <span class="string">&quot;Table dropped successfully on node <span class="variable">$current_node</span>. PostgreSQL is working properly.&quot;</span></span><br><span class="line">            <span class="built_in">exit</span> 0</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">log</span> <span class="string">&quot;Table not dropped successfully on node <span class="variable">$current_node</span>. Failover should be initiated!&quot;</span></span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Error creating table on node <span class="variable">$current_node</span>. Failover should be initiated!&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Setup priority and state keepalived script</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/bin/update_keepalived_priority.sh</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Configuration</span></span><br><span class="line">user=<span class="string">&#x27;repmgr&#x27;</span></span><br><span class="line">database=<span class="string">&#x27;repmgr&#x27;</span></span><br><span class="line">current_node=192.168.0.21</span><br><span class="line">config_file=<span class="string">&#x27;/etc/keepalived/keepalived.conf&#x27;</span></span><br><span class="line">primary_priority=100</span><br><span class="line">standby_priority=90</span><br><span class="line">log_file=<span class="string">&#x27;/var/log/update_keepalived_priority.log&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Logging function</span></span><br><span class="line"><span class="function"><span class="title">log</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(date +&#x27;%Y-%m-%d %H:%M:%S&#x27;)</span> - <span class="variable">$1</span>&quot;</span> | <span class="built_in">tee</span> -a <span class="variable">$log_file</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;Checking PostgreSQL role on node <span class="variable">$current_node</span>...&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Check if the node is primary</span></span><br><span class="line">is_primary=$(psql -h <span class="variable">$current_node</span> -U <span class="variable">$user</span> -d <span class="variable">$database</span> -tAc <span class="string">&quot;SELECT pg_is_in_recovery()&quot;</span> 2&gt;&gt; <span class="variable">$log_file</span>)</span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Error checking role of the node <span class="variable">$current_node</span>.&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Determine current priority and state in keepalived.conf</span></span><br><span class="line">current_priority=$(grep -E <span class="string">&quot;^\s*priority&quot;</span> <span class="variable">$config_file</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line">current_state=$(grep -E <span class="string">&quot;^\s*state&quot;</span> <span class="variable">$config_file</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;Current priority: <span class="variable">$current_priority</span>&quot;</span></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;Current state: <span class="variable">$current_state</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Update the priority and state if they do not match the role</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$is_primary</span>&quot;</span> == <span class="string">&quot;f&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$current_priority</span>&quot;</span> -ne <span class="variable">$primary_priority</span> ] || [ <span class="string">&quot;<span class="variable">$current_state</span>&quot;</span> != <span class="string">&quot;MASTER&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Node <span class="variable">$current_node</span> is primary. Updating priority to <span class="variable">$primary_priority</span> and state to MASTER.&quot;</span></span><br><span class="line">        sed -i <span class="string">&quot;s/^\s*priority.*/    priority <span class="variable">$primary_priority</span>/&quot;</span> <span class="variable">$config_file</span></span><br><span class="line">        sed -i <span class="string">&quot;s/^\s*state.*/    state MASTER/&quot;</span> <span class="variable">$config_file</span></span><br><span class="line">        systemctl reload keepalived</span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Keepalived priority updated to <span class="variable">$primary_priority</span> and state to MASTER. Service reloaded.&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Node <span class="variable">$current_node</span> is primary and keepalived is already set to priority <span class="variable">$primary_priority</span> and state MASTER. No changes made.&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$current_priority</span>&quot;</span> -ne <span class="variable">$standby_priority</span> ] || [ <span class="string">&quot;<span class="variable">$current_state</span>&quot;</span> != <span class="string">&quot;BACKUP&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Node <span class="variable">$current_node</span> is standby. Updating priority to <span class="variable">$standby_priority</span> and state to BACKUP.&quot;</span></span><br><span class="line">        sed -i <span class="string">&quot;s/^\s*priority.*/    priority <span class="variable">$standby_priority</span>/&quot;</span> <span class="variable">$config_file</span></span><br><span class="line">        sed -i <span class="string">&quot;s/^\s*state.*/    state BACKUP/&quot;</span> <span class="variable">$config_file</span></span><br><span class="line">        systemctl reload keepalived</span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Keepalived priority updated to <span class="variable">$standby_priority</span> and state to BACKUP. Service reloaded.&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Node <span class="variable">$current_node</span> is standby and keepalived is already set to priority <span class="variable">$standby_priority</span> and state BACKUP. No changes made.&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>add script to crontab</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab -e</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * * * * /usr/local/bin/update_keepalived_priority.sh</span><br></pre></td></tr></table></figure>


<p>Restart service and verify</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo useradd -r keepalived_script</span><br><span class="line">keepalived -t -f /etc/keepalived/keepalived.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">enable</span> keepalived</span><br><span class="line">sudo systemctl restart keepalived</span><br><span class="line">sudo systemctl status keepalived</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip addr show ens3</span><br></pre></td></tr></table></figure>

<h5 id="Execute-on-standby-node"><a href="#Execute-on-standby-node" class="headerlink" title="Execute on standby node"></a>Execute on standby node</h5><p>Configure file keepalived.conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">echo</span> <span class="string">&#x27;&#x27;</span> &gt; /var/log/update_keepalived_priority.log</span><br><span class="line">sudo <span class="built_in">cp</span> /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.backup</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/keepalived/keepalived.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">    script_user root</span><br><span class="line">    enable_script_security</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vrrp_script pg_check &#123;</span><br><span class="line">      script <span class="string">&quot;/usr/local/bin/check_postgres.sh&quot;</span></span><br><span class="line">      interval 5</span><br><span class="line">      <span class="built_in">timeout</span> 5</span><br><span class="line">      rise 3</span><br><span class="line">      fall 3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens3</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 90</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass repmgrpa</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.0.50/24 dev ens3</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        pg_check</span><br><span class="line">    &#125;</span><br><span class="line">    notify_backup <span class="string">&quot;/usr/local/bin/follow.sh&quot;</span></span><br><span class="line">    notify_fault <span class="string">&quot;/usr/local/bin/follow.sh&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Create healtcheck script</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">touch</span> /usr/local/bin/check_postgres.sh</span><br><span class="line"><span class="built_in">chmod</span> +x /usr/local/bin/check_postgres.sh</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/bin/check_postgres.sh</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Configuration</span></span><br><span class="line">user=<span class="string">&#x27;repmgr&#x27;</span></span><br><span class="line">database=<span class="string">&#x27;repmgr&#x27;</span></span><br><span class="line">logfile=<span class="string">&#x27;/var/log/check_postgres.log&#x27;</span></span><br><span class="line">current_node=<span class="string">&#x27;192.168.0.22&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Logging function</span></span><br><span class="line"><span class="function"><span class="title">log</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(date +&#x27;%Y-%m-%d %H:%M:%S&#x27;)</span> - <span class="variable">$1</span>&quot;</span> | <span class="built_in">tee</span> -a <span class="variable">$logfile</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;Checking PostgreSQL status on node <span class="variable">$current_node</span>...&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Check if the node is in recovery mode (standby)</span></span><br><span class="line">is_standby=$(psql -h <span class="variable">$current_node</span> -U <span class="variable">$user</span> -d <span class="variable">$database</span> -tAc <span class="string">&quot;SELECT pg_is_in_recovery()&quot;</span> 2&gt;&gt; <span class="variable">$logfile</span>)</span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Error checking recovery mode on node <span class="variable">$current_node</span>.&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$is_standby</span>&quot;</span> == <span class="string">&quot;t&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Node <span class="variable">$current_node</span> is standby. Checking replication status.&quot;</span></span><br><span class="line">    replication_status=$(psql -h <span class="variable">$current_node</span> -U <span class="variable">$user</span> -d <span class="variable">$database</span> -tAc <span class="string">&quot;SELECT pg_last_wal_receive_lsn() IS NOT NULL AND pg_last_wal_replay_lsn() IS NOT NULL&quot;</span> 2&gt;&gt; <span class="variable">$logfile</span>)</span><br><span class="line">    <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Error checking replication status on node <span class="variable">$current_node</span>.&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$replication_status</span>&quot;</span> == <span class="string">&quot;t&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Replication is active on node <span class="variable">$current_node</span>. PostgreSQL is working properly.&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 0</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Replication is not active on node <span class="variable">$current_node</span>. Failover should be initiated!&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Node <span class="variable">$current_node</span> is primary. Performing create/drop table check.&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Drop the test table if it exists</span></span><br><span class="line">    psql -h <span class="variable">$current_node</span> -U <span class="variable">$user</span> -d <span class="variable">$database</span> -c <span class="string">&quot;DROP TABLE IF EXISTS test;&quot;</span> 2&gt;&gt; <span class="variable">$logfile</span></span><br><span class="line">    <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Error dropping existing test table on node <span class="variable">$current_node</span>. Failover should be initiated!&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Create the test table</span></span><br><span class="line">    psql -h <span class="variable">$current_node</span> -U <span class="variable">$user</span> -d <span class="variable">$database</span> -c <span class="string">&quot;CREATE TABLE test (id serial primary key, data varchar(255));&quot;</span> 2&gt;&gt; <span class="variable">$logfile</span></span><br><span class="line">    <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Error creating table on node <span class="variable">$current_node</span>. Failover should be initiated!&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    table_check=$(psql -h <span class="variable">$current_node</span> -U <span class="variable">$user</span> -d <span class="variable">$database</span> -tAc <span class="string">&quot;SELECT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = &#x27;test&#x27;);&quot;</span> 2&gt;&gt; <span class="variable">$logfile</span>)</span><br><span class="line">    <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Error checking table existence on node <span class="variable">$current_node</span>.&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$table_check</span>&quot;</span> == <span class="string">&quot;t&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Table created successfully on node <span class="variable">$current_node</span>.&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Drop the test table</span></span><br><span class="line">        psql -h <span class="variable">$current_node</span> -U <span class="variable">$user</span> -d <span class="variable">$database</span> -c <span class="string">&quot;DROP TABLE test;&quot;</span> 2&gt;&gt; <span class="variable">$logfile</span></span><br><span class="line">        <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">log</span> <span class="string">&quot;Error dropping table on node <span class="variable">$current_node</span>. Failover should be initiated!&quot;</span></span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        table_check=$(psql -h <span class="variable">$current_node</span> -U <span class="variable">$user</span> -d <span class="variable">$database</span> -tAc <span class="string">&quot;SELECT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = &#x27;test&#x27;);&quot;</span> 2&gt;&gt; <span class="variable">$logfile</span>)</span><br><span class="line">        <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">log</span> <span class="string">&quot;Error checking table existence after drop on node <span class="variable">$current_node</span>.&quot;</span></span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$table_check</span>&quot;</span> == <span class="string">&quot;f&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">log</span> <span class="string">&quot;Table dropped successfully on node <span class="variable">$current_node</span>. PostgreSQL is working properly.&quot;</span></span><br><span class="line">            <span class="built_in">exit</span> 0</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">log</span> <span class="string">&quot;Table not dropped successfully on node <span class="variable">$current_node</span>. Failover should be initiated!&quot;</span></span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Error creating table on node <span class="variable">$current_node</span>. Failover should be initiated!&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Setup priority and state keepalived script</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/bin/update_keepalived_priority.sh</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Configuration</span></span><br><span class="line">user=<span class="string">&#x27;repmgr&#x27;</span></span><br><span class="line">database=<span class="string">&#x27;repmgr&#x27;</span></span><br><span class="line">current_node=192.168.0.22</span><br><span class="line">config_file=<span class="string">&#x27;/etc/keepalived/keepalived.conf&#x27;</span></span><br><span class="line">primary_priority=100</span><br><span class="line">standby_priority=90</span><br><span class="line">log_file=<span class="string">&#x27;/var/log/update_keepalived_priority.log&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Logging function</span></span><br><span class="line"><span class="function"><span class="title">log</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(date +&#x27;%Y-%m-%d %H:%M:%S&#x27;)</span> - <span class="variable">$1</span>&quot;</span> | <span class="built_in">tee</span> -a <span class="variable">$log_file</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;Checking PostgreSQL role on node <span class="variable">$current_node</span>...&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Check if the node is primary</span></span><br><span class="line">is_primary=$(psql -h <span class="variable">$current_node</span> -U <span class="variable">$user</span> -d <span class="variable">$database</span> -tAc <span class="string">&quot;SELECT pg_is_in_recovery()&quot;</span> 2&gt;&gt; <span class="variable">$log_file</span>)</span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Error checking role of the node <span class="variable">$current_node</span>.&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Determine current priority and state in keepalived.conf</span></span><br><span class="line">current_priority=$(grep -E <span class="string">&quot;^\s*priority&quot;</span> <span class="variable">$config_file</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line">current_state=$(grep -E <span class="string">&quot;^\s*state&quot;</span> <span class="variable">$config_file</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;Current priority: <span class="variable">$current_priority</span>&quot;</span></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;Current state: <span class="variable">$current_state</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Update the priority and state if they do not match the role</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$is_primary</span>&quot;</span> == <span class="string">&quot;f&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$current_priority</span>&quot;</span> -ne <span class="variable">$primary_priority</span> ] || [ <span class="string">&quot;<span class="variable">$current_state</span>&quot;</span> != <span class="string">&quot;MASTER&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Node <span class="variable">$current_node</span> is primary. Updating priority to <span class="variable">$primary_priority</span> and state to MASTER.&quot;</span></span><br><span class="line">        sed -i <span class="string">&quot;s/^\s*priority.*/    priority <span class="variable">$primary_priority</span>/&quot;</span> <span class="variable">$config_file</span></span><br><span class="line">        sed -i <span class="string">&quot;s/^\s*state.*/    state MASTER/&quot;</span> <span class="variable">$config_file</span></span><br><span class="line">        systemctl reload keepalived</span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Keepalived priority updated to <span class="variable">$primary_priority</span> and state to MASTER. Service reloaded.&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Node <span class="variable">$current_node</span> is primary and keepalived is already set to priority <span class="variable">$primary_priority</span> and state MASTER. No changes made.&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$current_priority</span>&quot;</span> -ne <span class="variable">$standby_priority</span> ] || [ <span class="string">&quot;<span class="variable">$current_state</span>&quot;</span> != <span class="string">&quot;BACKUP&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Node <span class="variable">$current_node</span> is standby. Updating priority to <span class="variable">$standby_priority</span> and state to BACKUP.&quot;</span></span><br><span class="line">        sed -i <span class="string">&quot;s/^\s*priority.*/    priority <span class="variable">$standby_priority</span>/&quot;</span> <span class="variable">$config_file</span></span><br><span class="line">        sed -i <span class="string">&quot;s/^\s*state.*/    state BACKUP/&quot;</span> <span class="variable">$config_file</span></span><br><span class="line">        systemctl reload keepalived</span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Keepalived priority updated to <span class="variable">$standby_priority</span> and state to BACKUP. Service reloaded.&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">log</span> <span class="string">&quot;Node <span class="variable">$current_node</span> is standby and keepalived is already set to priority <span class="variable">$standby_priority</span> and state BACKUP. No changes made.&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>


<p>add script to crontab</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab -e</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * * * * /usr/local/bin/update_keepalived_priority.sh</span><br></pre></td></tr></table></figure>


<p>Restart service and verify</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo useradd -r keepalived_script</span><br><span class="line">keepalived -t -f /etc/keepalived/keepalived.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">enable</span> keepalived</span><br><span class="line">sudo systemctl restart keepalived</span><br><span class="line">sudo systemctl status keepalived</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip addr show ens3</span><br></pre></td></tr></table></figure>
<h4 id="Step-8-Verify-the-Setup"><a href="#Step-8-Verify-the-Setup" class="headerlink" title="Step 8: Verify the Setup"></a>Step 8: Verify the Setup</h4><p>Create the <code>check_postgres.sh</code> script to monitor PostgreSQL.<br>Check the status of repmgr:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br></pre></td></tr></table></figure>

<p>Check the status of keepalived:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl status keepalived</span><br></pre></td></tr></table></figure>


<h3 id="HA-TESTING"><a href="#HA-TESTING" class="headerlink" title="HA TESTING"></a>HA TESTING</h3><p>1. <strong>Checking Cluster Status</strong><br>On ilham-node1 (primary node)<br>Cluster Status Verification</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">date</span>; sudo -u postgres repmgr -f /etc/repmgr/16/repmgr.conf cluster show</span><br><span class="line"><span class="built_in">date</span>; ip addr show ens3</span><br></pre></td></tr></table></figure>

<p>2. <strong>Simulate Failover</strong><br>Stop PostgreSQL on the Primary Node</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">date</span>; sudo systemctl stop postgresql</span><br><span class="line"><span class="built_in">date</span>; sudo systemctl status postgresql</span><br></pre></td></tr></table></figure>

<p>Check Logs for Failover Events at Standby node:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">tail</span> -f /var/log/repmgr/repmgr.log</span><br></pre></td></tr></table></figure>
<p>3. <strong>Post-Failover Cluster Status Check</strong><br>At standby node<br>Cluster Status Verification</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">date</span>; sudo -u postgres repmgr -f /etc/repmgr/16/repmgr.conf cluster show</span><br><span class="line"><span class="built_in">date</span>; ip addr show ens3</span><br></pre></td></tr></table></figure>

<p>Monitor keepalived logs to track the state transitions and ensure the node is correctly managed as a backup.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">tail</span> -f /var/log/syslog | grep -i keepalived</span><br></pre></td></tr></table></figure>


<p>4. <strong>Reintegration of Failure Node into the Cluster</strong></p>
<p>Check vrrp ip at failure node </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">date</span>; ip addr show ens3</span><br></pre></td></tr></table></figure>

<p>Start the PostgreSQL service on ilham-node1 (Failure Node) and verify its status to reintegrate the node into the cluster.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">date</span>; sudo systemctl start postgresql; <span class="built_in">sleep</span> 2; sudo systemctl status postgresql</span><br><span class="line"><span class="built_in">date</span>; ip addr show ens3</span><br></pre></td></tr></table></figure>

<p>Check keepalived log at ilham-node1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">tail</span> -f /var/log/syslog | grep -i keepalived</span><br></pre></td></tr></table></figure>
<p>The transitions from FAULT STATE to BACKUP STATE show that keepalived successfully manages the state of the node, ensuring it is ready to serve as a standby in the high availability setup.</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/database/">database</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/database/" rel="tag">database</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/keepalived/" rel="tag">keepalived</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/postgresql/" rel="tag">postgresql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/replication/" rel="tag">replication</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/repmgr/" rel="tag">repmgr</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2020/04/13/efk-stack-fluentd-parsing/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">EFK Stack - Parsing Log with Fluentd</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">Contents</strong>
    
      <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#PostgreSQL-HA-with-repmgr-and-keepalived-pg-rewind"><span class="nav-number">1.</span> <span class="nav-text">PostgreSQL HA with repmgr and keepalived (pg_rewind)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#PostgreSQL"><span class="nav-number">1.1.</span> <span class="nav-text">PostgreSQL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PostgreSQL-HA-with-keepalived-and-repmgr"><span class="nav-number">1.2.</span> <span class="nav-text">PostgreSQL HA with keepalived and repmgr</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HLD"><span class="nav-number">1.3.</span> <span class="nav-text">HLD</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Recovery-Scenario"><span class="nav-number">1.4.</span> <span class="nav-text">Recovery Scenario</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Step-by-Step-Configuration-and-Testing"><span class="nav-number">1.5.</span> <span class="nav-text">Step-by-Step Configuration and Testing</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Cluster-Configuration"><span class="nav-number">1.5.1.</span> <span class="nav-text">Cluster Configuration</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-1-Setup-PostgreSQL-on-all-nodes"><span class="nav-number">1.5.1.1.</span> <span class="nav-text">Step 1: Setup PostgreSQL on all nodes</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Execute-on-both-node"><span class="nav-number">1.5.1.1.1.</span> <span class="nav-text">Execute on both node</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-2-Configure-PostgreSQL-for-Replication"><span class="nav-number">1.5.1.2.</span> <span class="nav-text">Step 2: Configure PostgreSQL for Replication</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Execute-on-both-node-1"><span class="nav-number">1.5.1.2.1.</span> <span class="nav-text">Execute on both node</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-3-Initialize-the-Primary-Node-ilham-node1"><span class="nav-number">1.5.1.3.</span> <span class="nav-text">Step 3: Initialize the Primary Node (ilham-node1)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Execute-on-primary-node-ilham-node1"><span class="nav-number">1.5.1.3.1.</span> <span class="nav-text">Execute on primary node (ilham-node1)</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-4-Initialize-the-Standby-Node-ilham-node2"><span class="nav-number">1.5.1.4.</span> <span class="nav-text">Step 4: Initialize the Standby Node (ilham-node2)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Execute-on-standby-node-ilham-node2"><span class="nav-number">1.5.1.4.1.</span> <span class="nav-text">Execute on standby node (ilham-node2)</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-5-Setup-replication-cluster"><span class="nav-number">1.5.1.5.</span> <span class="nav-text">Step 5: Setup replication cluster</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Execute-on-primary-node-ilham-node1-1"><span class="nav-number">1.5.1.5.1.</span> <span class="nav-text">Execute on primary node (ilham-node1)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Execute-on-standby-node-ilham-node2-1"><span class="nav-number">1.5.1.5.2.</span> <span class="nav-text">Execute on standby node (ilham-node2)</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-6-Setup-Repmgrd-Service-w-Systemd"><span class="nav-number">1.5.1.6.</span> <span class="nav-text">Step 6: Setup Repmgrd Service w&#x2F; Systemd</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Execute-on-both-node-2"><span class="nav-number">1.5.1.6.1.</span> <span class="nav-text">Execute on both node</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-7-Configure-keepalived"><span class="nav-number">1.5.1.7.</span> <span class="nav-text">Step 7: Configure keepalived</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Execute-on-primary-node"><span class="nav-number">1.5.1.7.1.</span> <span class="nav-text">Execute on primary node</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Execute-on-standby-node"><span class="nav-number">1.5.1.7.2.</span> <span class="nav-text">Execute on standby node</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Step-8-Verify-the-Setup"><span class="nav-number">1.5.1.8.</span> <span class="nav-text">Step 8: Verify the Setup</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HA-TESTING"><span class="nav-number">1.5.2.</span> <span class="nav-text">HA TESTING</span></a></li></ol></li></ol></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Beranda</a>
  
    <a href="/archives" class="mobile-nav-link">Arsip</a>
  
    <a href="/categories" class="mobile-nav-link">Kategori</a>
  
    <a href="/about" class="mobile-nav-link">Tentang</a>
  
</nav> -->
    <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2024 | ILOSAURUS |  All Rights Reserved.
       
      </div>
      <div class="site-credit">
        Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
      </div>
  </div>
</footer>


<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
    
    
    
</script>
    
<!-- <div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div> -->

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?...">
</script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>


<script src="/js/bootstrap.js"></script>


<script src="/js/main.js"></script>








  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
</body>
</html>
